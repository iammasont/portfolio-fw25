---
// Clean, performant Custom Cursor (Dot + Trailing Ring)
// Updated to work with Astro View Transitions
---

<div id="custom-dot"></div>
<div id="trailing-ring"></div>

<style>
    :root {
        --dot-size: 10px; 
    }

    body {
        cursor: none;
    }

    /* --- 1. Custom Dot (Highest Z-index, INSTANT tracking) --- */
    #custom-dot {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--dot-size);
        height: var(--dot-size);
        background-color: var(--black);
        border-radius: 50%;
        transform: translate(-50%, -50%); 
        z-index: 10002; /* Above everything */
        pointer-events: none;
    }

    /* --- 2. Trailing Ring (Smooth, delayed tracking) --- */
    #trailing-ring {
        position: fixed;
        top: 0;
        left: 0;
        width: 32px; /* Base size */
        height: 32px;
        border: 2px solid var(--black);
        background-color: transparent;
        border-radius: 50%;
        opacity: 0.5;
        z-index: 10001; 
        pointer-events: none;
        transform: translate(-50%, -50%); 
    }

    @media (hover: none) and (pointer: coarse) {
        #custom-dot,
        #trailing-ring {
            display: none;
        }
        
        body {
            cursor: auto !important;
        }
    }
</style>

<script>
    // --- MAIN INITIALIZATION FUNCTION ---
    let animationFrameId;
    let mouseMoveHandler;
    let resizeHandler;
    
    function init() {
        const dot = document.getElementById('custom-dot');
        const ring = document.getElementById('trailing-ring');
        
        if (!dot || !ring) return;

        let W = window.innerWidth;
        let H = window.innerHeight;
        
        // --- INPUT & POSITION STATE ---
        let mousePos = { x: W / 2, y: H / 2 };
        let ringPos = { x: W / 2, y: H / 2 }; 
        const RING_EASING = 0.15;
        
        let lastTime = performance.now();
        
        // --- HANDLERS ---
        mouseMoveHandler = function(e) {
            dot.style.left = `${e.clientX}px`;
            dot.style.top = `${e.clientY}px`;
            mousePos.x = e.clientX;
            mousePos.y = e.clientY; 
        };

        resizeHandler = function() {
            W = window.innerWidth;
            H = window.innerHeight;
        };

        function draw(time) {
            const deltaTime = time - lastTime;
            lastTime = time;
            
            ringPos.x += (mousePos.x - ringPos.x) * RING_EASING;
            ringPos.y += (mousePos.y - ringPos.y) * RING_EASING;

            ring.style.left = `${ringPos.x}px`;
            ring.style.top = `${ringPos.y}px`;
            
            animationFrameId = requestAnimationFrame(draw);
        }

        // --- STARTUP ---
        window.addEventListener('mousemove', mouseMoveHandler);
        window.addEventListener('resize', resizeHandler);
        
        resizeHandler();
        draw(performance.now());
    }
    
    function cleanup() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        if (mouseMoveHandler) {
            window.removeEventListener('mousemove', mouseMoveHandler);
        }
        if (resizeHandler) {
            window.removeEventListener('resize', resizeHandler);
        }
    }

    // Initialize on page load (works with View Transitions)
    document.addEventListener('astro:page-load', init);
    
    // Cleanup before navigation
    document.addEventListener('astro:before-preparation', cleanup);
    
    // Initialize immediately if DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
</script>
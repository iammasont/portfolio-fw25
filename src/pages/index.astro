---
// src/pages/index.astro
// This is your main page, updated to use Tina CMS data
import Layout from '../layouts/Layout.astro';
import HeroWebGL from '../components/HeroWebGL.astro';
import ProjectCard from '../components/ProjectCard.astro';
import { readdirSync, readFileSync } from 'fs';
import { join } from 'path';

// Read all project files from the data directory
const projectsDir = join(process.cwd(), 'src', 'data', 'projects');
const projectFiles = readdirSync(projectsDir).filter(file => file.endsWith('.json'));

// Load and parse all projects
const allProjects = projectFiles.map(file => {
  const content = readFileSync(join(projectsDir, file), 'utf-8');
  return JSON.parse(content);
});

// Filter for featured and published projects only
const projects = allProjects
  .filter(project => project.featured && project.status === 'published')
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Helper function to convert category slug to display name
function getCategoryDisplay(slug: string): string {
  const categoryMap: Record<string, string> = {
    'live-events': 'Live Events',
    'installation': 'Installation',
    'broadcast': 'Broadcast',
    'concert': 'Concert',
    'experiential': 'Experiential',
    'corporate': 'Corporate'
  };
  return categoryMap[slug] || slug;
}
---
<!-- We wrap everything in the Layout component -->
<Layout title="Nate Wilkens - Portfolio">
  
  <!-- Here is your Hero component -->
  <HeroWebGL />

  <!-- Here is the Projects section -->
  <section id="projects">
    <div class="section-header">
        <div class="year-label">Selected Work / 2024</div>
        <h2 class="section-title">Projects</h2>
    </div>
    
    <div class="project-grid">
      <!-- 
        We map over the projects array from Tina and render a ProjectCard
        component for each one, passing in the data as props.
      -->
      {projects.map(project => (
        <ProjectCard 
          category={getCategoryDisplay(project.category)} 
          title={project.title} 
          tags={project.tags}
          slug={project.slug}
        />
      ))}
    </div>
  </section>

</Layout>

<!-- 
  This client script applies the .is-long class
  to project titles that need it.
-->
<script is:inline>
  function adjustProjectTitles() {
      const titles = document.querySelectorAll('.project-title');
      // This is the character count threshold you can tweak
      const LONG_TITLE_THRESHOLD = 28; 

      titles.forEach(title => {
          if (!title) return; // Safety check
          const length = title.textContent.trim().length;
          if (length > LONG_TITLE_THRESHOLD) {
              title.classList.add('is-long');
          } else {
              title.classList.remove('is-long');
          }
      });
  }
  
  // Run when the page loads
  document.addEventListener('astro:page-load', adjustProjectTitles);
  // Re-run on resize for responsive clamp() changes
  window.addEventListener('resize', adjustProjectTitles);
</script>

<!-- 
  These are page-specific styles for the layout
  of the projects section.
-->
<style>
  #projects {
      background: var(--red);
      padding: 0 5svw 100px;
      position: relative;
  }
  
  .section-header {
      margin-bottom: 40px;
  }
  
  .year-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      font-weight: 500;
  }
  
  .section-title {
      font-family: 'Geist', sans-serif;
      font-weight: 700;
      font-size: clamp(2rem, 8svw, 5rem);
      letter-spacing: -0.03em;
      line-height: 1.1;
  }
  
  .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 40px 30px;
      max-width: 1400px;
      /* This prevents items from stretching to the tallest height */
      align-items: start;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
      #projects {
          padding: 0 5svw 60px;
      }
      
      .project-grid {
          grid-template-columns: 1fr;
          gap: 36px;
      }
      
      .section-header {
          margin-bottom: 32px;
      }
  }
</style>